{{/*
Copyright 2026 Team 254. All Rights Reserved.
Author: pat@patfairbank.com (Patrick Fairbank)
Modified for 2026 REBUILT Game

UI for the real-time scoring interface.
*/}}
{{define "title"}}Scoring Panel - {{.PositionName}}{{end}}

{{/* 新增 head 定義，解決 template "head" not defined 錯誤 */}}
{{define "head"}}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  /* 優化觸控體驗，防止雙擊放大 */
  body {
    touch-action: manipulation;
    overscroll-behavior: none;
  }
  .btn-lg {
    padding-top: 1rem;
    padding-bottom: 1rem;
  }
  /* 讓按鈕在被點擊時有明顯回饋 */
  .btn:active {
    transform: scale(0.98);
  }
</style>
{{end}}

{{define "body"}}
<div class="container-fluid" style="margin-top: 10px;">
  <div class="row">
    <div class="col-md-3">
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h4 class="card-title mb-0">{{.Position.Title}}</h4>
        </div>
        <div class="card-body">
          <h1 id="match_time" class="display-4 text-center">0:00</h1>
          <h3 id="match_state" class="text-center text-muted">Pre-Match</h3>
          <hr>
          <div class="d-grid gap-2">
            <button class="btn btn-warning btn-lg" onclick="resetLocalState()">Resync / Reset</button>
          </div>
        </div>
      </div>
      <div class="card mb-3" id="hub-status-card">
    <div class="card-header bg-dark text-white text-center">
      <h5 class="mb-0">Hub Status</h5>
    </div>
    <div class="card-body text-center p-4">
      <div id="hub-status-indicator" class="h2 fw-bold p-3 rounded" style="transition: all 0.3s ease;">
        HUB INITIALIZING
      </div>
    </div>
  </div>

      <!--<div class="card border-danger">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Fouls</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-danger btn-lg" onclick="addFoul(false)">
              Minor Foul (3pts)
            </button>
            <button class="btn btn-danger btn-lg" onclick="addFoul(true)">
              Major Foul (12pts)
            </button>
            <button class="btn btn-dark btn-sm mt-2" onclick="addSpecificFoul('G206', true)">
              G206 (RP Violation)
            </button>
          </div>
        </div>
      </div>-->
    </div>

    <div class="col-md-9">
      <div class="card mb-3 border-info" id="auto-panel">
        <div class="card-header bg-info text-white">
          <h4 class="mb-0">Autonomous Period</h4>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-6">
              <h5>Auto Fuel (1 pt)</h5>
              <div class="input-group input-group-lg justify-content-center">
                <button class="btn btn-danger" onclick="updateFuel(true, -1)">-</button>
                <span class="input-group-text" style="width: 80px; justify-content: center;" id="auto_fuel_count">0</span>
                <button class="btn btn-success" onclick="updateFuel(true, 1)">+</button>
              </div>
            </div>
            
            <div class="col-md-6">
              <h5>Auto Tower (Level 1 - 10 pts)</h5>
              <div class="d-flex justify-content-around mt-2">
                <div class="btn-group-vertical" role="group">
                  <span class="mb-1 fw-bold">Robot 1</span>
                  <input type="checkbox" class="btn-check" id="auto_tower_0" autocomplete="off" onchange="updateAutoTower(0, this.checked)">
                  <label class="btn btn-outline-primary btn-lg" for="auto_tower_0">Success</label>
                </div>
                <div class="btn-group-vertical" role="group">
                  <span class="mb-1 fw-bold">Robot 2</span>
                  <input type="checkbox" class="btn-check" id="auto_tower_1" autocomplete="off" onchange="updateAutoTower(1, this.checked)">
                  <label class="btn btn-outline-primary btn-lg" for="auto_tower_1">Success</label>
                </div>
                <div class="btn-group-vertical" role="group">
                  <span class="mb-1 fw-bold">Robot 3</span>
                  <input type="checkbox" class="btn-check" id="auto_tower_2" autocomplete="off" onchange="updateAutoTower(2, this.checked)">
                  <label class="btn btn-outline-primary btn-lg" for="auto_tower_2">Success</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3 border-success" id="teleop-panel">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">Teleop Period</h4>
        </div>
        <div class="card-body">
          <div class="row text-center justify-content-center">
            <div class="col-md-6">
              <h3>Teleop Fuel (1 pt)</h3>
              <div class="input-group input-group-lg justify-content-center mt-3" style="transform: scale(1.5);">
                <button class="btn btn-danger" onclick="updateFuel(false, -1)">-</button>
                <span class="input-group-text" style="width: 80px; justify-content: center;" id="teleop_fuel_count">0</span>
                <button class="btn btn-success" onclick="updateFuel(false, 1)">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3 border-warning" id="endgame-panel">
        <div class="card-header bg-warning text-dark">
          <h4 class="mb-0">Endgame (Climb)</h4>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-4 border-end">
              <h5>Robot 1</h5>
              <div class="btn-group-vertical w-100" role="group">
                <input type="radio" class="btn-check" name="climb_0" id="climb_0_none" value="0" checked onchange="updateClimb(0, 0)">
                <label class="btn btn-outline-secondary" for="climb_0_none">None</label>

                <input type="radio" class="btn-check" name="climb_0" id="climb_0_lvl1" value="1" onchange="updateClimb(0, 1)">
                <label class="btn btn-outline-info" for="climb_0_lvl1">Level 1</label>

                <input type="radio" class="btn-check" name="climb_0" id="climb_0_lvl2" value="2" onchange="updateClimb(0, 2)">
                <label class="btn btn-outline-primary" for="climb_0_lvl2">Level 2</label>

                <input type="radio" class="btn-check" name="climb_0" id="climb_0_lvl3" value="3" onchange="updateClimb(0, 3)">
                <label class="btn btn-outline-success" for="climb_0_lvl3">Level 3</label>
              </div>
            </div>

            <div class="col-md-4 border-end">
              <h5>Robot 2</h5>
              <div class="btn-group-vertical w-100" role="group">
                <input type="radio" class="btn-check" name="climb_1" id="climb_1_none" value="0" checked onchange="updateClimb(1, 0)">
                <label class="btn btn-outline-secondary" for="climb_1_none">None</label>

                <input type="radio" class="btn-check" name="climb_1" id="climb_1_lvl1" value="1" onchange="updateClimb(1, 1)">
                <label class="btn btn-outline-info" for="climb_1_lvl1">Level 1</label>

                <input type="radio" class="btn-check" name="climb_1" id="climb_1_lvl2" value="2" onchange="updateClimb(1, 2)">
                <label class="btn btn-outline-primary" for="climb_1_lvl2">Level 2 </label>

                <input type="radio" class="btn-check" name="climb_1" id="climb_1_lvl3" value="3" onchange="updateClimb(1, 3)">
                <label class="btn btn-outline-success" for="climb_1_lvl3">Level 3 </label>
              </div>
            </div>

            <div class="col-md-4">
              <h5>Robot 3</h5>
              <div class="btn-group-vertical w-100" role="group">
                <input type="radio" class="btn-check" name="climb_2" id="climb_2_none" value="0" checked onchange="updateClimb(2, 0)">
                <label class="btn btn-outline-secondary" for="climb_2_none">None</label>

                <input type="radio" class="btn-check" name="climb_2" id="climb_2_lvl1" value="1" onchange="updateClimb(2, 1)">
                <label class="btn btn-outline-info" for="climb_2_lvl1">Level 1</label>

                <input type="radio" class="btn-check" name="climb_2" id="climb_2_lvl2" value="2" onchange="updateClimb(2, 2)">
                <label class="btn btn-outline-primary" for="climb_2_lvl2">Level 2 </label>

                <input type="radio" class="btn-check" name="climb_2" id="climb_2_lvl3" value="3" onchange="updateClimb(2, 3)">
                <label class="btn btn-outline-success" for="climb_2_lvl3">Level 3 </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2">
        <button id="commit_btn" class="btn btn-primary btn-lg p-4" onclick="commitScore()" disabled>
          <h3>WAIT FOR MATCH END</h3>
        </button>
      </div>

    </div>
  </div>
</div>
{{end}}

{{define "script"}}
<script>
  var ws = null;
  var position = "{{.PositionName}}"; // "red_near", "blue_far", etc.
  var alliance = "{{.Position.Alliance}}"; // "red" or "blue"
  
  // Local state tracking
  var autoFuel = 0;
  var teleopFuel = 0;

  $(document).ready(function() {
    connectWebsocket();
  });

  function connectWebsocket() {
    if (ws) return;
    var loc = window.location;
    var new_uri;
    if (loc.protocol === "https:") {
      new_uri = "wss:";
    } else {
      new_uri = "ws:";
    }
    new_uri += "//" + loc.host + "/panels/scoring/" + position + "/websocket";
    
    ws = new WebSocket(new_uri);
    ws.onopen = function() {
      // Subscribe to updates
      ws.send(JSON.stringify({type: "subscribe"}));
    };
    
    ws.onmessage = function(event) {
      var msg = JSON.parse(event.data);
      if (msg.type === "matchTime") {
        updateMatchTime(msg.data);
      } else if (msg.type === "realtimeScore") {
        updateScoreDisplay(msg.data);
      } else if (msg.type === "resetLocalState") {
        resetLocalState();
      }
    };

    ws.onclose = function() {
      ws = null;
      setTimeout(connectWebsocket, 1000);
    };
  }

  function sendCommand(cmd, data) {
    if (ws) {
      ws.send(JSON.stringify({
        type: "score",
        data: {
          command: cmd,
          data: data
        }
      }));
    }
  }

  // --- 2026 Game Logic Functions ---

  function updateFuel(isAuto, delta) {
    sendCommand("fuel", {
      Adjustment: delta,
      Autonomous: isAuto
    });
  }

  function updateAutoTower(robotIdx, checked) {
    sendCommand("auto_tower", {
      RobotIndex: robotIdx,
      Adjustment: checked ? 1 : 0
    });
  }

  function updateClimb(robotIdx, level) {
    sendCommand("climb", {
      RobotIndex: robotIdx,
      Level: level
    });
  }

  function addFoul(isMajor) {
    sendCommand("foul", {
      Alliance: alliance, // Opponent foul logic handled by backend if needed, or panel is assigned to opponent
      RuleId: 0, // Generic
      IsMajor: isMajor
    });
  }
  
  function addSpecificFoul(rule, isMajor) {
    // Need mapping for Rule ID, placeholder for now
    addFoul(isMajor); 
  }

  function commitScore() {
    sendCommand("commitMatch", {});
    $("#commit_btn").text("SCORE COMMITTED").addClass("btn-secondary").removeClass("btn-primary").prop("disabled", true);
  }

  // --- UI Update Functions ---

  function updateMatchTime(data) {
    var totalSec = data.MatchTimeSec;
    var min = Math.floor(totalSec / 60);
    var sec = totalSec % 60;
    $("#match_time").text(min + ":" + (sec < 10 ? "0" : "") + sec);

    var stateText = "Pre-Match";
    var canScore = false;
    
    // MatchState enums: PreMatch=0, StartMatch=1, Warmup=2, Auto=3, Pause=4, Teleop=5, PostMatch=6
    switch(data.MatchState) {
      case 0: stateText = "Pre-Match"; break;
      case 3: 
        stateText = "Autonomous"; 
        $("#auto-panel").css("opacity", "1");
        $("#teleop-panel").css("opacity", "0.5");
        canScore = true;
        break;
      case 4: stateText = "Pause"; break;
      case 5: 
        stateText = "Teleop"; 
        $("#auto-panel").css("opacity", "0.5");
        $("#teleop-panel").css("opacity", "1");
        canScore = true;
        break;
      case 6: 
        stateText = "Post-Match"; 
        $("#commit_btn").prop("disabled", false).text("COMMIT SCORE");
        break;
    }
    $("#match_state").text(stateText);
  }

  function updateScoreDisplay(data) {
    // data structure depends on ArenaNotifiers.go
    // Assuming data contains { Red: { Score: {...} }, Blue: {...} }
    var myScore;
    if (alliance === "red") {
      myScore = data.Red.Score;
    } else {
      myScore = data.Blue.Score;
    }

    if (!myScore) return;

    // Sync Fuel Counts
    $("#auto_fuel_count").text(myScore.AutoFuelCount);
    $("#teleop_fuel_count").text(myScore.TeleopFuelCount);

    // Sync Auto Tower
    for (var i = 0; i < 3; i++) {
      $("#auto_tower_" + i).prop("checked", myScore.AutoTowerLevel1[i]);
    }

    // Sync Endgames (Optional: only if you want bidirectional sync)
    for (var i = 0; i < 3; i++) {
      var status = myScore.EndgameStatuses[i];
      // status: 0=None, 1=Level1, 2=Level2, 3=Level3
      $(`input[name=climb_${i}][value=${status}]`).prop("checked", true);
    }
  }

  function resetLocalState() {
    autoFuel = 0;
    teleopFuel = 0;
    $("#commit_btn").text("WAIT FOR MATCH END").prop("disabled", true).removeClass("btn-secondary").addClass("btn-primary");
  }
</script>
{{end}}