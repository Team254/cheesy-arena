{{/*
Copyright 2014 Team 254. All Rights Reserved.
Author: pat@patfairbank.com (Patrick Fairbank)

UI for manually editing the result for a match - 2026 REBUILT Version
*/}}
{{define "title"}}Edit Match Results{{end}}
{{define "body"}}
<div class="row">
  <div class="card card-body bg-body-tertiary">
    <form method="POST">
      <fieldset>
        <legend>Edit {{.Match.LongName}} Results</legend>
        <div id="redScore"></div>
        <div id="blueScore"></div>
        <div class="row">
          <div class="text-center col-lg-12">
            <a href="{{if .IsCurrentMatch}}/match_play{{else}}/match_review{{end}}">
              <button type="button" class="btn btn-secondary">Cancel</button>
            </a>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </fieldset>
    </form>
  </div>
</div>

<div id="scoreTemplate" style="display: none;">
  <div class="card card-body bg-{{"{{alliance}}"}} mb-3">
  <fieldset>
    <legend>Autonomous</legend>
    <h6 class="fw-bold mb-2">Bypassed</h6>
    <div class="row mb-3">
      {{range $i := seq 3}}
      <div class="col-lg-2">
        <label class="control-label">Team {{"{{team"}}{{$i}}{{"}}"}}</label>
        <input type="checkbox" class="ms-3" name="{{"{{alliance}}"}}RobotsBypassed{{$i}}">
      </div>
      {{end}}
    </div>
    <h6 class="fw-bold mb-2">AutoTowerlevel1</h6>
    <div class="row mb-3">
      {{range $i := seq 3}}
      <div class="col-lg-2">
        <label class="control-label">Team {{"{{team"}}{{$i}}{{"}}"}}</label>
        <input type="checkbox" class="ms-3" name="{{"{{alliance}}"}}AutoTowerLevel1{{$i}}">
      </div>
      {{end}}
    </div>
  </fieldset>

 <fieldset>
  <legend>Game Elements (2026 REBUILT)</legend>
  <div class="row mb-3">
    <label class="col-lg-2 text-end">Auto FUEL:</label>
    <div class="col-lg-2">
      <input type="number" class="form-control input-sm" name="{{"{{alliance}}"}}AutoFuelCount">
    </div>
    <label class="col-lg-2 text-end">Teleop FUEL:</label>
    <div class="col-lg-2">
      <input type="number" class="form-control input-sm" name="{{"{{alliance}}"}}TeleopFuelCount">
    </div>
  </div>
  <hr/>
  <h6 class="fw-bold mb-2">TOWER Status</h6>
  {{range $i := seq 3}}
  <div class="row mb-2">
    <label class="col-lg-2 control-label text-end">Team {{"{{team"}}{{$i}}{{"}}"}}:</label>
    <div class="col-lg-8">
      <label class="me-2"><input type="radio" name="{{"{{../alliance}}"}}EndgameStatuses{{$i}}" value="1"> Level 1</label>
      <label class="me-2"><input type="radio" name="{{"{{../alliance}}"}}EndgameStatuses{{$i}}" value="2"> Level 2</label>
      <label class="me-2"><input type="radio" name="{{"{{../alliance}}"}}EndgameStatuses{{$i}}" value="3"> Level 3</label>
      <label class="me-2"><input type="radio" name="{{"{{../alliance}}"}}EndgameStatuses{{$i}}" value="0" checked> None</label>
    </div>
  </div>
  {{end}}
</fieldset>

  <fieldset>
    <legend>Fouls</legend>
    {{"{{#each score.Fouls}}"}}
    <input type="hidden" class="input-sm" name="{{"{{../alliance}}"}}Foul{{"{{@index}}"}}Index" value="{{"{{@index}}"}}">
    <div class="card card-body bg-dark-{{"{{../alliance}}"}} mb-2">
      <button type="button" class="btn-close" onclick="deleteFoul('{{"{{../alliance}}"}}', {{"{{@index}}"}});"></button>
      <div class="row mb-2">
        <label class="col-lg-2 control-label">Is Major?</label>
        <div class="col-lg-3">
          <input type="checkbox" class="input-sm" name="{{"{{../alliance}}"}}Foul{{"{{@index}}"}}IsMajor">
        </div>
      </div>
      <div class="row mb-2">
        <label class="col-lg-2 control-label">Team</label>
        <div class="col-lg-8">
          <label class="me-3"><input type="radio" name="{{"{{../alliance}}"}}Foul{{"{{@index}}"}}Team" value="{{"{{../team1}}"}}"> {{"{{../team1}}"}}</label>
          <label class="me-3"><input type="radio" name="{{"{{../alliance}}"}}Foul{{"{{@index}}"}}Team" value="{{"{{../team2}}"}}"> {{"{{../team2}}"}}</label>
          <label class="me-3"><input type="radio" name="{{"{{../alliance}}"}}Foul{{"{{@index}}"}}Team" value="{{"{{../team3}}"}}"> {{"{{../team3}}"}}</label>
        </div>
      </div>
      <div class="row">
        <label class="col-lg-2 control-label">Rule</label>
        <div class="col-lg-9">
          <select class="form-control" name="{{"{{../alliance}}"}}Foul{{"{{@index}}"}}RuleId">
            <option value="0">-- Select Rule --</option>
            {{range $rule := .Rules}}
            <option value="{{$rule.Id}}">{{$rule.RuleNumber}}: {{$rule.Description}}</option>
            {{end}}
          </select>
        </div>
      </div>
    </div>
    {{"{{/each}}"}}
    <button type="button" class="btn btn-secondary btn-sm" onclick="addFoul('{{"{{alliance}}"}}');">Add Foul</button>
  </fieldset>

  <fieldset class="mt-3">
    <legend>Cards</legend>
    {{range $i := seq 3}}
    <div class="row mb-2">
      <label class="col-lg-2 control-label">Team {{"{{team"}}{{$i}}{{"}}"}}</label>
      <div class="col-lg-8">
        <label class="me-2"><input type="radio" name="{{"{{alliance}}"}}Team{{"{{team"}}{{$i}}{{"}}"}}Card" value="" checked> None</label>
        <label class="me-2"><input type="radio" name="{{"{{alliance}}"}}Team{{"{{team"}}{{$i}}{{"}}"}}Card" value="yellow"> Yellow</label>
        <label class="me-2"><input type="radio" name="{{"{{alliance}}"}}Team{{"{{team"}}{{$i}}{{"}}"}}Card" value="red"> Red</label>
        <label class="me-2"><input type="radio" name="{{"{{alliance}}"}}Team{{"{{team"}}{{$i}}{{"}}"}}Card" value="dq"> DQ</label>
      </div>
    </div>
    {{end}}
  </fieldset>
  </div>
</div>
{{end}}

{{define "script"}}
<script src="/static/js/match_review.js"></script>
<script>
  var matchId = {{.Match.Id}};
// 修正：使用更安全的方式解析 JSON，避免 unexpected end of input
  var rawJson = {{.MatchResultJson}}; 
  
  if (!rawJson || rawJson === "") {
    matchResult = { RedScore: {Fouls:[]}, BlueScore: {Fouls:[]} };
  } else {
    try {
      matchResult = (typeof rawJson === "string") ? JSON.parse(rawJson) : rawJson;
    } catch (e) {
      console.error("MatchResultJson parse error:", e);
      matchResult = { RedScore: {Fouls:[]}, BlueScore: {Fouls:[]} };
    }
  }

  allianceResults["red"] = {
    alliance: "red",
    team1: {{.Match.Red1}},
    team2: {{.Match.Red2}},
    team3: {{.Match.Red3}},
    score: matchResult.RedScore || { Fouls: [] },
    cards: matchResult.RedCards || {},
  };
  allianceResults["blue"] = {
    alliance: "blue",
    team1: {{.Match.Blue1}},
    team2: {{.Match.Blue2}},
    team3: {{.Match.Blue3}},
    score: matchResult.BlueScore || { Fouls: [] },
    cards: matchResult.BlueCards || {},
  };

  // 渲染頁面
  renderResults("red");
  renderResults("blue");
  </script>
{{end}}