{{/*
Copyright 2019 Team 254. All Rights Reserved.
Author: pat@patfairbank.com (Patrick Fairbank)

UI for configuring the awards.
*/}}
{{define "title"}}Awards Configuration{{end}}
{{define "body"}}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card card-body bg-body-tertiary">
      <legend>Awards Configuration</legend>

      {{range $award := .Awards}}
      <form class="mt-2" method="POST" autocomplete="off">
        <input type="hidden" name="id" value="{{$award.Id}}"/>

        <div class="row mb-3">
          <div class="col-lg-8">
            <!-- Award Name -->
            <div class="row mb-2">
              <label class="col-sm-5 control-label">Award Name</label>
              <div class="col-sm-7">
                <input
                  type="text"
                  class="form-control"
                  name="awardName"
                  value="{{$award.AwardName}}"
                  placeholder="Safety Award"
                  autocomplete="off"
                  spellcheck="false">
              </div>
            </div>

            <!-- Team Awarded -->
            <div class="row mb-2 align-items-center">
              <label class="col-sm-5 control-label">Team Awarded</label>
              <div class="col-sm-7 d-flex align-items-center gap-2">
                <select class="form-control team-select"
                  name="teamId"
                  data-award-id="{{$award.Id}}"
                  data-initial-team="{{$award.TeamId}}">
                  <option value="0">No Team</option>
                  {{range $team := $.Teams}}
                  <option value="{{$team.Id}}" {{if eq $award.TeamId $team.Id}} selected{{end}}>
                    {{$team.Id}} - {{$team.Nickname}}
                  </option>
                  {{end}}
                </select>
                <button type="button"
                  class="btn btn-outline-secondary btn-sm team-mask-toggle"
                  data-award-id="{{$award.Id}}">
                  Reveal
                </button>
              </div>
            </div>

            <!-- Person Awarded -->
            <div class="row mb-2">
              <label class="col-sm-5 control-label">Person Awarded</label>
              <div class="col-sm-7">
                <input type="text"
                  class="form-control"
                  name="personName"
                  value="{{$award.PersonName}}"
                  autocomplete="off"
                  spellcheck="false">
              </div>
            </div>
          </div>

          <div class="col-lg-4 d-flex gap-2 align-items-start">
            <button type="submit" class="btn btn-primary" name="action" value="save">Save</button>
            {{if gt $award.Id 0}}
            <button type="submit" class="btn btn-danger" name="action" value="delete">Delete</button>
            {{end}}
          </div>
        </div>
      </form>
      {{end}}

      <div class="text-body-secondary">
        Winner and Finalist awards will be automatically generated once the playoff tournament is complete.
        {{if .EventSettings.TbaPublishingEnabled}}
        <br/><br/>
        <p>Awards are not automatically published to The Blue Alliance. Manually publish them from the Settings tab.</p>
        {{end}}
      </div>
    </div>
  </div>
</div>
{{end}}

{{define "script"}}
<script>
  (function () {
    document.querySelectorAll('.team-select').forEach(select => {
      const awardId = select.getAttribute('data-award-id');
      const btn = document.querySelector(`.team-mask-toggle[data-award-id="${awardId}"]`);

      function mask() {
        if (select.value !== "0") {
          const opt = select.options[select.selectedIndex];
          opt.setAttribute('data-real-label', opt.textContent);
          opt.textContent = "HIDDEN TEAM";
          select.dataset.hidden = "1";
          btn.textContent = "Reveal";
        }
      }

      function unmask() {
        if (select.dataset.hidden === "1") {
          const opt = select.options[select.selectedIndex];
          opt.textContent = opt.getAttribute('data-real-label');
          select.dataset.hidden = "0";
          btn.textContent = "Hide";
        }
      }

      // Initialize hidden state if there is a team
      if (select.value !== "0") {
        mask();
      }

      btn.addEventListener('click', () => {
        if (select.dataset.hidden === "1") {
          unmask();
        } else {
          mask();
        }
      });

      // If user changes to No Team, always unmask
      select.addEventListener('change', () => {
        if (select.value === "0") {
          select.dataset.hidden = "0";
          btn.textContent = "Reveal";
        } else {
          mask();
        }
      });
    });
  })();
</script>
{{end}}
