{{/*
Copyright 2014 Team 254. All Rights Reserved.
Author: pat@patfairbank.com (Patrick Fairbank)

UI for listing matches and their results.
*/}}
{{define "title"}}Match Review{{end}}
{{define "body"}}
<div class="row">
  <ul class="nav nav-tabs">
    <li>
      <a href="#Practice" class="nav-link{{if eq .CurrentMatchType practiceMatch }} active{{end}}" data-bs-toggle="tab">
        Practice
      </a>
    </li>
    <li>
      <a href="#Qualification" class="nav-link{{if eq .CurrentMatchType qualificationMatch }} active{{end}}"
        data-bs-toggle="tab">
        Qualification
      </a>
    </li>
    <li>
      <a href="#Playoff" class="nav-link{{if eq .CurrentMatchType playoffMatch }} active{{end}}" data-bs-toggle="tab">
        Playoff
      </a>
    </li>
  </ul>
  <div class="tab-content">
    {{range $type, $matches := .MatchesByType}}
    <div class="tab-pane {{if eq $.CurrentMatchType $type }} active{{end}}" id="{{$type}}">
      <table class="table table-striped table-hover ">
        <thead>
          <tr>
            <th>Match</th>
            <th>Time</th>
            <th class="text-center">Red Alliance</th>
            <th class="text-center">Blue Alliance</th>
            <th class="text-center">Red Score</th>
            <th class="text-center">Blue Score</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          {{range $m := $matches}}
          <tr>
            <td class="bg-{{$m.ColorClass}}">{{$m.ShortName}}</td>
            <td class="bg-{{$m.ColorClass}}">{{$m.Time}}</td>
            <td class="bg-{{$m.ColorClass}} text-center red-text">
              {{index $m.RedTeams 0}}, {{index $m.RedTeams 1}}, {{index $m.RedTeams 2}}
            </td>
            <td class="bg-{{$m.ColorClass}} text-center blue-text">
              {{index $m.BlueTeams 0}}, {{index $m.BlueTeams 1}}, {{index $m.BlueTeams 2}}
            </td>
            <td class="bg-{{$m.ColorClass}} text-center red-text">{{if $m.IsComplete}}{{$m.RedScore}}{{end}}</td>
            <td class="bg-{{$m.ColorClass}} text-center blue-text">{{if $m.IsComplete}}{{$m.BlueScore}}{{end}}</td>
            <td class="bg-{{$m.ColorClass}} text-center nowrap">
              <a href="/match_review/{{$m.Id}}/edit"><b class="btn btn-primary btn-sm">Edit</b></a>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}
  </div>
</div>
{{end}}
{{define "script"}}
<script src="/static/js/match_review.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    // 從 Go 後端傳入的 JSON 字串解析出原始資料
    matchResult = JSON.parse({{.MatchResultJson}});
    var rawJson = {{.MatchResultJson}};
        
        if (!rawJson || rawJson === "") {
            matchResult = { 
                RedScore: { Fouls: [], RobotsBypassed: [false,false,false], AutoTowerLevel1: [false,false,false], EndgameStatuses: [0,0,0] }, 
                BlueScore: { Fouls: [], RobotsBypassed: [false,false,false], AutoTowerLevel1: [false,false,false], EndgameStatuses: [0,0,0] } 
            };
        } else {
            try {
                matchResult = (typeof rawJson === "string") ? JSON.parse(rawJson) : rawJson;
            } catch (e) {
                console.error("MatchResultJson parse error:", e);
                matchResult = { RedScore: {Fouls:[]}, BlueScore: {Fouls:[]} };
            }
        }
    // 初始化紅方資料
    allianceResults["red"] = {
      team1: {{.Match.Red1}},
      team2: {{.Match.Red2}},
      team3: {{.Match.Red3}},
      score: matchResult.RedScore || { Fouls: [], RobotsBypassed: [false,false,false], LeaveStatuses: [false,false,false], EndgameStatuses: [0,0,0] },
      cards: matchResult.RedCards || {}
    };

    // 初始化藍方資料
    allianceResults["blue"] = {
      team1: {{.Match.Blue1}},
      team2: {{.Match.Blue2}},
      team3: {{.Match.Blue3}},
      score: matchResult.BlueScore || { Fouls: [], RobotsBypassed: [false,false,false], LeaveStatuses: [false,false,false], EndgameStatuses: [0,0,0] },
      cards: matchResult.BlueCards || {}
    };

    // 執行渲染，如果 JS 沒報錯，藍方就會出現
    renderResults("red");
    renderResults("blue");
  });
</script>
{{end}}
